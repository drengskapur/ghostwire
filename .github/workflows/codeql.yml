name: Static Analysis

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    # Run at 6:00 UTC every Monday
    - cron: '0 6 * * 1'

permissions: {}

jobs:
  shellcheck:
    name: ShellCheck Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write  # For uploading SARIF results
      contents: read          # For checking out code

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Run ShellCheck
        id: shellcheck
        uses: ludeeus/action-shellcheck@00b27aa7cb85167568cb48a3838b75f4265f2bca # 2.0.0
        with:
          scandir: './scripts'
          severity: warning
          format: sarif
        continue-on-error: true

      - name: Upload ShellCheck SARIF
        if: always() && hashFiles('shellcheck.sarif') != ''
        uses: github/codeql-action/upload-sarif@42213152a85ae7569bdb6bec7bcd74cd691bfe41 # v3.30.9
        with:
          sarif_file: shellcheck.sarif
          category: shellcheck

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Run yamllint
        run: |
          pip install yamllint
          yamllint -d "{extends: default, rules: {line-length: {max: 120}}}" \
            .github/workflows/ \
            chart/ \
            || true  # Don't fail build, just report
