suite: test helpers
templates:
  - service.yaml  # We use service.yaml as a template to test helpers
tests:
  - it: should generate correct chart name
    template: service.yaml
    asserts:
      - equal:
          path: metadata.labels["helm.sh/chart"]
          value: signal-system-0.1.0

  - it: should generate correct fullname
    template: service.yaml
    release:
      name: my-release
    asserts:
      - equal:
          path: metadata.name
          value: my-release-signal-system

  - it: should use fullnameOverride when specified
    template: service.yaml
    set:
      fullnameOverride: custom-name
    asserts:
      - equal:
          path: metadata.name
          value: custom-name

  - it: should truncate fullname to 63 characters
    template: service.yaml
    release:
      name: very-long-release-name-for-testing-truncation-ok
    asserts:
      - matchRegex:
          path: metadata.name
          pattern: ^.{1,63}$

  - it: should generate correct app name label
    template: service.yaml
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: signal-system

  - it: should use nameOverride when specified
    template: service.yaml
    set:
      nameOverride: custom-app-name
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: custom-app-name

  - it: should include instance label
    template: service.yaml
    release:
      name: test-instance
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: test-instance

  - it: should include version label
    template: service.yaml
    chart:
      appVersion: 1.18.0
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/version"]
          value: "1.18.0"

  - it: should include managed-by label
    template: service.yaml
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/managed-by"]
          value: Helm

  - it: should use release name when it contains chart name
    template: service.yaml
    release:
      name: signal-system
    asserts:
      - equal:
          path: metadata.name
          value: signal-system

  - it: should include selector labels
    template: service.yaml
    release:
      name: my-release
    asserts:
      - equal:
          path: spec.selector["app.kubernetes.io/name"]
          value: signal-system
      - equal:
          path: spec.selector["app.kubernetes.io/instance"]
          value: my-release
