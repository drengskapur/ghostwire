suite: test statefulset
templates:
  - statefulset-ghostwire.yaml
tests:
  ## Basic StatefulSet Configuration
  - it: should create a StatefulSet with default values
    asserts:
      - isKind:
          of: StatefulSet
      - equal:
          path: metadata.name
          value: RELEASE-NAME-ghostwire
      - equal:
          path: spec.replicas
          value: 1
      - equal:
          path: spec.serviceName
          value: RELEASE-NAME-ghostwire

  ## Container Configuration
  - it: should configure signal container with default image
    asserts:
      - equal:
          path: spec.template.spec.containers[0].name
          value: signal
      - equal:
          path: spec.template.spec.containers[0].image
          value: kasmweb/signal:1.18.0
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: IfNotPresent

  - it: should use custom image when specified
    set:
      image.repository: custom/signal
      image.tag: 2.0.0
      image.pullPolicy: Always
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: custom/signal:2.0.0
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always

  ## Authentication Configuration
  - it: should set default VNC auth credentials
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: VNC_USER
            value: kasm_user
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: VNC_PW
            value: testpass123

  - it: should set custom VNC auth credentials
    set:
      auth.username: myuser
      auth.password: mypass123
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: VNC_USER
            value: myuser
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: VNC_PW
            value: mypass123

  - it: should not include VNCOPTIONS when auth is enabled
    set:
      auth.enabled: true
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: VNCOPTIONS

  - it: should disable basic auth when auth.enabled is false
    set:
      auth.enabled: false
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: VNCOPTIONS
            value: "-PreferBandwidth -DynamicQualityMin=4 -DynamicQualityMax=7 -DLP_ClipDelay=0 -disableBasicAuth"

  ## Display Configuration
  - it: should set default VNC resolution
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: VNC_RESOLUTION
            value: "1280x720"

  - it: should set custom VNC resolution
    set:
      display.resolution: "1920x1080"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: VNC_RESOLUTION
            value: "1920x1080"

  ## Additional Environment Variables
  - it: should include additional env variables when specified
    set:
      env:
        - name: CUSTOM_VAR
          value: custom_value
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CUSTOM_VAR
            value: custom_value

  - it: should include envFrom when specified
    set:
      envFrom:
        - secretRef:
            name: my-secret
    asserts:
      - equal:
          path: spec.template.spec.containers[0].envFrom[0].secretRef.name
          value: my-secret

  ## Health Probes
  - it: should configure TCP liveness probe when enabled
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.tcpSocket.port
          value: 6901
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 60
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 30

  - it: should not include liveness probe when disabled
    set:
      livenessProbe.enabled: false
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].livenessProbe

  - it: should configure TCP readiness probe when enabled
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.tcpSocket.port
          value: 6901
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.initialDelaySeconds
          value: 30
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.periodSeconds
          value: 10

  - it: should not include readiness probe when disabled
    set:
      readinessProbe.enabled: false
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].readinessProbe

  ## Resources
  - it: should set default resource limits and requests
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 2000m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 4Gi
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 500m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 1Gi

  ## Persistence
  - it: should create volumeClaimTemplate when persistence enabled
    asserts:
      - equal:
          path: spec.volumeClaimTemplates[0].metadata.name
          value: signal-data
      - equal:
          path: spec.volumeClaimTemplates[0].spec.accessModes[0]
          value: ReadWriteOnce
      - equal:
          path: spec.volumeClaimTemplates[0].spec.resources.requests.storage
          value: 10Gi

  - it: should not create volumeClaimTemplate when persistence disabled
    set:
      persistence.enabled: false
    asserts:
      - isNull:
          path: spec.volumeClaimTemplates

  - it: should mount signal-data volume when persistence enabled
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: signal-data
            mountPath: /home/kasm-user

  - it: should mount dshm volume for shared memory
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: dshm
            mountPath: /dev/shm

  - it: should set dshm size from values
    set:
      shmSize: 512
    asserts:
      - equal:
          path: spec.template.spec.volumes[0].emptyDir.sizeLimit
          value: 512Mi

  ## Security Context
  - it: should apply security context
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 1000
      - equal:
          path: spec.template.spec.securityContext.runAsGroup
          value: 1000
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 1000

  ## Pod Configuration
  - it: should apply pod annotations when specified
    set:
      podAnnotations:
        prometheus.io/scrape: "true"
    asserts:
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/scrape"]
          value: "true"

  - it: should apply pod labels when specified
    set:
      podLabels:
        custom: label
    asserts:
      - equal:
          path: spec.template.metadata.labels.custom
          value: label

  - it: should include component label
    asserts:
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/component"]
          value: app

  ## Scheduling
  - it: should set nodeSelector when specified
    set:
      nodeSelector:
        disktype: ssd
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector.disktype
          value: ssd

  - it: should set tolerations when specified
    set:
      tolerations:
        - key: "key1"
          operator: "Equal"
          value: "value1"
          effect: "NoSchedule"
    asserts:
      - equal:
          path: spec.template.spec.tolerations[0].key
          value: key1

  - it: should set affinity when specified
    set:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: kubernetes.io/hostname
                    operator: In
                    values:
                      - node1
    asserts:
      - isNotNull:
          path: spec.template.spec.affinity.nodeAffinity
