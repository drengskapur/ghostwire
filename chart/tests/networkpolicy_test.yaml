suite: test network policies
templates:
  - networkpolicy-ghostwire.yaml
tests:
  ## Network Policy Disabled
  - it: should not create network policies when disabled
    template: networkpolicy-ghostwire.yaml
    set:
      networkPolicy.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  ## Ghostwire Network Policy
  - it: should create ghostwire network policy
    template: networkpolicy-ghostwire.yaml
    set:
      networkPolicy.enabled: true
    asserts:
      - isKind:
          of: NetworkPolicy
      - equal:
          path: metadata.name
          value: RELEASE-NAME-ghostwire
      - equal:
          path: spec.podSelector.matchLabels["app.kubernetes.io/component"]
          value: app

  - it: should allow all ingress when ingress controller not enabled
    template: networkpolicy-ghostwire.yaml
    set:
      networkPolicy.enabled: true
      ingress.enabled: false
    asserts:
      - contains:
          path: spec.ingress
          content:
            from: []
            ports:
              - protocol: TCP
                port: 6901

  - it: should allow internet egress when configured
    template: networkpolicy-ghostwire.yaml
    set:
      networkPolicy.enabled: true
      networkPolicy.allowInternetEgress: true
    asserts:
      - contains:
          path: spec.egress
          content:
            to:
              - namespaceSelector: {}
            ports:
              - protocol: TCP
                port: 443
              - protocol: TCP
                port: 80
