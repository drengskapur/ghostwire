# yaml-language-server: $schema=values.schema.json
#
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ Ghostwire - Signal Desktop Helm Chart - Production-Ready Default Values         â”‚
# â”‚                                                                                 â”‚
# â”‚ ğŸ”´ IMPORTANT: This chart includes default values for initial testing.           â”‚
# â”‚    For production deployments, you MUST:                                        â”‚
# â”‚                                                                                 â”‚
# â”‚    1. Change ALL default passwords (VNC_PW, cookie secret, htpasswd entries)    â”‚
# â”‚    2. Use external secret management for credentials                            â”‚
# â”‚    3. Enable TLS/HTTPS with proper certificates                                 â”‚
# â”‚    4. Review and adjust resource limits based on your workload                  â”‚
# â”‚    5. Configure proper storage classes for your environment                     â”‚
# â”‚                                                                                 â”‚
# â”‚ ğŸ“– See README.md for detailed configuration instructions                        â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## @section Global parameters
##
## @param nameOverride Override chart name
## @param fullnameOverride Override fully qualified app name
##
nameOverride: ""
fullnameOverride: ""

## @section Image Configuration
## Signal Desktop container image configuration
##
## @param image.repository Signal Desktop image repository
## @param image.tag Signal Desktop image tag (immutable tags are recommended)
## @param image.digest Signal Desktop image digest (sha256 hash, takes precedence over tag)
## @param image.pullPolicy Image pull policy (Always, IfNotPresent, Never)
##
image:
  repository: kasmweb/signal
  tag: "1.18.0"
  ## Optionally specify image by digest (e.g., sha256:abc123...)
  ## digest: ""
  pullPolicy: IfNotPresent

## @param imagePullSecrets Docker registry secret names as an array
## ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/
##
imagePullSecrets: []

## @section Deployment Configuration
##
## @param replicaCount Number of Signal Desktop replicas (should be 1 for single-user)
## Signal Desktop is tied to a phone number, so only 1 replica is supported
##
replicaCount: 1

## @section Service Configuration
## Kubernetes Service configuration
##
## @param service.type Kubernetes Service type (ClusterIP, NodePort, LoadBalancer)
## @param service.port Service port for VNC access
## @param service.targetPort Container target port for VNC
## @param service.loadBalancerIP LoadBalancer IP address (for type: LoadBalancer with reserved IP)
##
service:
  type: ClusterIP
  port: 6901
  targetPort: 6901
  ## For LoadBalancer type on DigitalOcean with reserved IP
  ## Example: loadBalancerIP: "209.38.63.45"
  ##
  # loadBalancerIP: "209.38.63.45"

## @section Ingress Configuration
## Ingress configuration for external access
##
## @param ingress.enabled Enable ingress controller resource
## @param ingress.className Ingress class name (e.g., nginx)
## @param ingress.annotations Ingress annotations
## @param ingress.hosts Ingress host configuration
## @param ingress.tls Ingress TLS configuration
##
ingress:
  enabled: false
  className: ""
  ## Additional annotations for the Ingress resource
  ## Example: Enable TLS with cert-manager
  ##   cert-manager.io/cluster-issuer: letsencrypt-prod
  ##   nginx.ingress.kubernetes.io/proxy-body-size: "0"
  ##
  annotations: {}
  ## Ingress host configuration
  ##
  hosts:
    - host: signal.example.com
      paths:
        - path: /
          pathType: Prefix
  ## TLS configuration for HTTPS
  ## Example:
  ##   tls:
  ##     - secretName: signal-tls
  ##       hosts:
  ##         - signal.example.com
  ##
  tls: []

## @section Persistent Storage Configuration
## Persistent storage for Signal Desktop data
##
## @param persistence.enabled Enable persistent storage for Signal data
## @param persistence.storageClass PVC Storage Class (use default if empty)
## @param persistence.accessMode PVC Access Mode (ReadWriteOnce recommended)
## @param persistence.size PVC Storage Request size
## @param persistence.mountPath Container mount path for Signal data
##
persistence:
  enabled: true
  ## Storage class for PVC
  ## If undefined (default) or set to null, uses default provisioner
  ##
  # storageClass: ""
  accessMode: ReadWriteOnce
  size: 10Gi
  ## Path where Signal stores data in the KasmVNC container
  ##
  mountPath: /home/kasm-user

## @section Resource Configuration
## Resource limits and requests for Signal Desktop container
##
## @param resources.limits.cpu CPU limit
## @param resources.limits.memory Memory limit
## @param resources.requests.cpu CPU request
## @param resources.requests.memory Memory request
##
resources:
  limits:
    cpu: 2000m
    memory: 4Gi
  requests:
    cpu: 500m
    memory: 1Gi

## @section Security Configuration
## Pod and container security context
##
## @param securityContext.runAsUser User ID to run the container
## @param securityContext.runAsGroup Group ID to run the container
## @param securityContext.fsGroup Filesystem group ID for volumes
## @param securityContext.runAsNonRoot Ensure container runs as non-root
## @param securityContext.seccompProfile Seccomp profile configuration
##
securityContext:
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  runAsNonRoot: true
  seccompProfile:
    type: RuntimeDefault

## @section Container Security Context
## Container-level security settings
##
## @param containerSecurityContext.allowPrivilegeEscalation Prevent privilege escalation
## @param containerSecurityContext.capabilities.drop Dropped capabilities
## @param containerSecurityContext.readOnlyRootFilesystem Read-only root filesystem (disabled for KasmVNC)
##
containerSecurityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  ## Note: readOnlyRootFilesystem is NOT enabled for KasmVNC as it requires write access
  ## to /tmp, /home/kasm-user, and other runtime directories
  readOnlyRootFilesystem: false

## @section Authentication
## VNC authentication credentials
##
## @param auth.enabled Enable VNC password authentication (set to false to disable)
## @param auth.username VNC authentication username
## @param auth.password VNC authentication password
##
## âš ï¸  SECURITY: Change these credentials for production!
##
auth:
  enabled: true
  username: "kasm_user"
  password: "testpass123"

## @section TLS/SSL Configuration
## Custom SSL certificates for KasmVNC HTTPS/WebSocket connections
##
## @param tls.enabled Enable custom TLS certificates (if false, KasmVNC uses built-in self-signed)
## @param tls.secretName Name of existing Kubernetes secret containing TLS cert/key
## @param tls.cert TLS certificate (PEM format, inline - leave empty to use existing secret)
## @param tls.key TLS private key (PEM format, inline - leave empty to use existing secret)
## @param tls.certPath Container path for certificate file
## @param tls.keyPath Container path for private key file
##
## Example using existing secret:
##   tls:
##     enabled: true
##     secretName: ghostwire-tls
##
## Example with inline certificates:
##   tls:
##     enabled: true
##     cert: |
##       -----BEGIN CERTIFICATE-----
##       ...
##       -----END CERTIFICATE-----
##     key: |
##       -----BEGIN PRIVATE KEY-----
##       ...
##       -----END PRIVATE KEY-----
##
tls:
  enabled: false
  ## Use existing secret (leave empty to create from inline cert/key below)
  secretName: ""
  ## Inline certificate (only used if secretName is empty)
  cert: ""
  ## Inline private key (only used if secretName is empty)
  key: ""
  ## Certificate mount paths (KasmVNC standard paths)
  certPath: /tmp/vnc.crt
  keyPath: /tmp/vnc.key

## @section Display Configuration
## VNC display settings
##
## @param display.resolution VNC screen resolution
##
display:
  resolution: "1280x720"

## @section Environment Variables
## Additional environment configuration for KasmVNC and Signal
##
## @param env Array of additional environment variables
##
env: []
  # - name: CUSTOM_VAR
  #   value: "custom_value"

## @param shmSize Shared memory size in MB (for browser performance)
##
shmSize: 256

## @param envFrom Additional environment variables from secrets/configmaps
## Example:
##   envFrom:
##     - secretRef:
##         name: signal-secrets
##     - configMapRef:
##         name: signal-config
##
envFrom: []

## @section Pod Configuration
##
## @param podAnnotations Annotations for Signal Desktop pods
##
podAnnotations: {}

## @param podLabels Extra labels for Signal Desktop pods
##
podLabels: {}

## @param nodeSelector Node labels for pod assignment
## ref: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/
##
nodeSelector: {}

## @param tolerations Tolerations for pod assignment
## ref: https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/
##
tolerations: []

## @param affinity Affinity rules for pod assignment
## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity
##
affinity: {}

## @section Service Account
## Service account configuration
##
## @param serviceAccount.create Create service account
## @param serviceAccount.annotations Service account annotations
## @param serviceAccount.name Service account name (generated if not set)
##
serviceAccount:
  create: false
  annotations: {}
  name: ""

## @section Health Probes
## Liveness and readiness probe configuration
##
## @param livenessProbe.enabled Enable liveness probe
## @param livenessProbe.tcpSocket TCP socket probe
## @param livenessProbe.initialDelaySeconds Initial delay seconds
## @param livenessProbe.periodSeconds Period seconds
## @param livenessProbe.timeoutSeconds Timeout seconds
## @param livenessProbe.failureThreshold Failure threshold
##
livenessProbe:
  enabled: true
  tcpSocket:
    port: 6901
  initialDelaySeconds: 60
  periodSeconds: 30
  timeoutSeconds: 5
  failureThreshold: 3

## @param readinessProbe.enabled Enable readiness probe
## @param readinessProbe.tcpSocket TCP socket probe
## @param readinessProbe.initialDelaySeconds Initial delay seconds
## @param readinessProbe.periodSeconds Period seconds
## @param readinessProbe.timeoutSeconds Timeout seconds
## @param readinessProbe.failureThreshold Failure threshold
##
readinessProbe:
  enabled: true
  tcpSocket:
    port: 6901
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 3
  failureThreshold: 5

## @section Network Policy Configuration
## Network policies for pod-to-pod communication restrictions
##
## @param networkPolicy.enabled Enable network policies
## @param networkPolicy.allowInternetEgress Allow Ghostwire pods to access internet (required for Signal)
## @param networkPolicy.ingressControllerNamespaceSelector Namespace selector for ingress controller
## @param networkPolicy.ingressControllerPodSelector Pod selector for ingress controller
##
networkPolicy:
  enabled: true
  ## Allow internet egress for Signal Desktop functionality
  allowInternetEgress: true
  ## Ingress controller namespace selector (for ingress access to HAProxy)
  ## Default assumes ingress-nginx in ingress-nginx namespace
  ingressControllerNamespaceSelector:
    name: ingress-nginx
  ## Optional: Pod selector for ingress controller
  ## Leave empty to allow all pods from the namespace
  ingressControllerPodSelector: {}

## @section HAProxy Configuration
## HAProxy provides efficient HTTP/WebSocket proxying with connection pooling
##
## â„¹ï¸  HAProxy is OPTIONAL for this deployment:
##
## **Enable HAProxy (haproxy.enabled: true) if you want:**
##   - Explicit SSL/TLS verification control to backend
##   - Advanced health checks and observability
##   - Future expansion with multiple backend services
##   - Current footprint: ~1m CPU, ~66Mi memory
##
## **Disable HAProxy (haproxy.enabled: false) for:**
##   - Simpler architecture (Cloudflared â†’ Ghostwire directly)
##   - Lower resource usage (saves ~66Mi memory)
##   - Single-user Signal Desktop (recommended)
##
## âœ…  AUTOMATIC ROUTING: A "ghostwire-proxy" service automatically routes to the
##     correct backend (HAProxy or Ghostwire) based on this setting. No manual
##     configuration changes needed in Cloudflare Tunnel or Ingress!
##
##     Always use: http://ghostwire-proxy.namespace.svc.cluster.local:6901
##
haproxy:
  ## @param haproxy.enabled Enable HAProxy for VNC/WebSocket proxying
  enabled: true

  ## @param haproxy.replicaCount Number of HAProxy replicas
  replicaCount: 1

  ## @param haproxy.image HAProxy image configuration
  ## @param haproxy.image.repository HAProxy image repository
  ## @param haproxy.image.tag HAProxy image tag
  ## @param haproxy.image.pullPolicy Image pull policy
  image:
    repository: haproxytech/haproxy-alpine
    tag: "2.9"
    pullPolicy: IfNotPresent

  ## @param haproxy.securityContext Pod security context for HAProxy
  securityContext:
    runAsUser: 99  # HAProxy user
    runAsGroup: 99
    runAsNonRoot: true
    fsGroup: 99
    seccompProfile:
      type: RuntimeDefault

  ## @param haproxy.containerSecurityContext Container security context for HAProxy
  containerSecurityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: false

  ## @param haproxy.serviceAccount Service account configuration for HAProxy
  serviceAccount:
    create: true
    annotations: {}

  ## @param haproxy.ssl SSL/TLS configuration for backend connections
  ## @param haproxy.ssl.verify SSL verification mode (none, optional, required)
  ## @param haproxy.ssl.caSecret Name of secret containing CA certificate (tls.crt key)
  ##
  ## SSL verification modes:
  ##   none     - No certificate verification (default, works with self-signed certs)
  ##   optional - Verify if CA is available, but don't fail if verification fails
  ##   required - Strict verification, requires valid certificate and CA bundle
  ##
  ## For production with custom certificates, use 'required' mode and provide CA secret
  ssl:
    verify: none
    ## Optional: Secret containing CA certificate for backend SSL verification
    ## If provided, will be mounted and used for verification
    caSecret: ""

  ## @param haproxy.livenessProbe Liveness probe configuration for HAProxy
  livenessProbe:
    enabled: true
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 3
    failureThreshold: 3

  ## @param haproxy.readinessProbe Readiness probe configuration for HAProxy
  readinessProbe:
    enabled: true
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 2
    failureThreshold: 3

  ## @param haproxy.resources Resource limits for HAProxy
  resources:
    limits:
      cpu: 200m
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 32Mi
