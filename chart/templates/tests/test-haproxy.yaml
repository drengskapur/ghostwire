{{- if .Values.haproxy.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "ghostwire.fullname" . }}-test-haproxy
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ghostwire.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    - name: haproxy-test
      image: ghcr.io/drengskapur/ghostwire/debug:latest
      imagePullPolicy: IfNotPresent
      args:
        - -c
        - |
          echo "Testing HAProxy service connectivity..."

          # Test HAProxy service exists
          if timeout 5 bash -c "cat < /dev/null > /dev/tcp/{{ include "ghostwire.fullname" . }}-haproxy.{{ .Release.Namespace }}.svc.cluster.local/6901"; then
            echo "✅ HAProxy service is reachable on port 6901"
          else
            echo "❌ Failed to connect to HAProxy service"
            exit 1
          fi

          echo "✅ HAProxy connectivity test passed"
{{- end }}
