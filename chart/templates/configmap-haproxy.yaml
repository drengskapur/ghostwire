{{- if .Values.haproxy.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "ghostwire.fullname" . }}-haproxy
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ghostwire.labels" . | nindent 4 }}
    app.kubernetes.io/component: proxy
data:
  haproxy.cfg: |
    global
        log stdout format raw local0
        maxconn 1024

    defaults
        log global
        timeout client 3600s
        timeout connect 10s
        timeout server 3600s
        timeout tunnel 3600s
        mode http
        option httplog

    # VNC frontend - HTTP mode for WebSocket
    frontend vnc_frontend
        bind *:6901
        default_backend ghostwire_backend

    # Backend - HTTP mode with WebSocket support
    backend ghostwire_backend
        mode http
        balance roundrobin
        # TCP check instead of HTTP (VNC doesn't have unauthenticated HTTP endpoints)
        option tcp-check
        # WebSocket support
        http-request set-header X-Forwarded-Proto https if { ssl_fc }
        http-request set-header X-Forwarded-For %[src]
        # Connect to HTTPS endpoint (KasmVNC serves HTTPS)
        server {{ include "ghostwire.fullname" . }}-0 {{ include "ghostwire.fullname" . }}:6901 ssl verify none check inter 10s rise 2 fall 3
{{- end }}
